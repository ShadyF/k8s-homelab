---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: yourls
  namespace: default
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://k8s-at-home.com/charts/
      chart: yourls
      version: 5.2.20
      sourceRef:
        kind: HelmRepository
        name: yourls-charts
        namespace: flux-system
      interval: 5m
  values:

    image:
      registry: ghcr.io
      repository: yourls/yourls
      tag: 1.9.1

    replicaCount: 1
    updateStrategy:
      type: Recreate

    yourls:
      domain: "yourls.${SECRET_DOMAIN}"
      scheme: http
      existingSecret: yourls-secrets

    ingress:
      enabled: true
      ingressClassName: "nginx"
      hostname: "yourls.${SECRET_DOMAIN}"
      annotations:
        nginx.ingress.kubernetes.io/connection-proxy-header: "upgrade"
        nginx.ingress.kubernetes.io/auth-url: "http://oauth2-proxy.networking.svc.cluster.local/oauth2/auth"
        nginx.ingress.kubernetes.io/auth-signin: "https://auth.${SECRET_DOMAIN}/oauth2/sign_in"
      tls: true

    service:
      type: ClusterIP
      port: 80

    persistence:
      enabled: true
      storageClass: longhorn
      accessModes:
        - ReadWriteOnce
      size: 10Gi

    mariadb:
      auth:
        database: yourls
        username: yourls
        existingSecret: yourls-mariadb
      primary:
        persistence:
          enabled: true
          storageClass: longhorn
          accessModes:
            - ReadWriteOnce
          size: 8Gi