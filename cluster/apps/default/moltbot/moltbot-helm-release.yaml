apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: moltbot
  namespace: default
spec:
  interval: 15m
  chart:
    spec:
      chart: .
      sourceRef:
        kind: GitRepository
        name: moltbot
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  dependsOn:
    - name: longhorn
      namespace: longhorn-system
  values:
    image:
      repository: ghcr.io/moltbot/clawdbot
      tag: 2026.1.24-1
      pullPolicy: IfNotPresent

    replicaCount: 1

    env:
      NODE_ENV: production
      CLAWDBOT_STATE_DIR: /home/node/.clawdbot
      CLAWDBOT_WORKSPACE_DIR: /home/node/clawd
      NODE_OPTIONS: "--max-old-space-size=2048"

    config:
      # Create ConfigMap from inline config
      create: false


    gateway:
      bind: lan
      port: 18789
      allowUnconfigured: false

    persistence:
      enabled: true
      storageClass: "longhorn"
      accessMode: ReadWriteOnce
      size: 20Gi

    ingress:
      enabled: true
      className: internal
      annotations:
        nginx.ingress.kubernetes.io/auth-url: "http://oauth2-proxy.networking.svc.cluster.local/oauth2/auth"
        nginx.ingress.kubernetes.io/auth-signin: "https://auth.${SECRET_DOMAIN}/oauth2/sign_in"
        nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
        nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
        nginx.ingress.kubernetes.io/websocket-services: "moltbot"
        external-dns/is-public: "false"
        external-dns.alpha.kubernetes.io/target: "ipv4.${SECRET_DOMAIN}"
      hosts:
        - host: &host "moltbot.${SECRET_DOMAIN}"
          paths:
            - path: /
              pathType: Prefix
      tls:
        - hosts:
            - *host

    affinity:
      nodeAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
                - key: workload-type
                  operator: In
                  values:
                    - stateful