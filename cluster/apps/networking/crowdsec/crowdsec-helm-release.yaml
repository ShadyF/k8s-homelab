apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: crowdsec
  namespace: networking
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://crowdsecurity.github.io/helm-charts
      chart: crowdsec
      version: 0.9.8
      sourceRef:
        kind: HelmRepository
        name: crowdsec-charts
        namespace: flux-system
      interval: 5m
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    image:
      repository: crowdsecurity/crowdsec
      pullPolicy: IfNotPresent
      tag: v1.5.2
    agent:
      secrets:
        username: ${CROWDSEC_AGENT_USERNAME}
        password: ${CROWDSEC_AGENT_PASSWORD}
      strategy:
        type: Recreate
      acquisition:
        # Grafana, k8s audit, radarr, sonarr, proxmox, wireguard
        - namespace: ingress-nginx
          podName: ingress-nginx-controller-*
          # as in crowdsec configuration, we need to specify the program name so the parser will match and parse logs
          program: nginx
      env:
        # As it's a test, we don't want to share signals with CrowdSec so disable the Online API.
        #        - name: DISABLE_ONLINE_API
        #          value: "true"
        - name: DISABLE_LOCAL_API
          value: "true"
        - name: LOCAL_API_URL
          valueFrom:
            secretKeyRef:
              name: crowdsec-secrets
              key: CROWDSEC_API_URL
        # As we are running Nginx, we want to install the Nginx collection
        - name: COLLECTIONS
          value: "crowdsecurity/nginx"
    lapi:
      strategy:
        type: Recreate
      env:
        - name: DISABLE_ONLINE_API
          value: "true"
#        - name: DISABLE_LOCAL_API
#          value: "true"
        - name: LOCAL_API_URL
          valueFrom:
            secretKeyRef:
              name: crowdsec-secrets
              key: CROWDSEC_API_URL