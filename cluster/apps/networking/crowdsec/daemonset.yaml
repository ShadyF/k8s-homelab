apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: crowdsec-agent
  namespace: networking
  labels:
    k8s-app: crowdsec
    type: agent
    version: v1
spec:
  selector:
    matchLabels:
      k8s-app: crowdsec
      type: agent
  template:
    metadata:
      labels:
        k8s-app: crowdsec
        type: agent
        version: v1
    spec:
      containers:
        - name: crowdsec-agent
          image: crowdsecurity/crowdsec:v1.5.2
          imagePullPolicy: IfNotPresent
          env:
            - name: DISABLE_LOCAL_API
              value: "true"
            - name: DISABLE_ONLINE_API
              value: "true"
            - name: LOCAL_API_URL
              valueFrom:
                secretKeyRef:
                  name: crowdsec-secrets
                  key: CROWDSEC_API_URL
            - name: AGENT_USERNAME
              valueFrom:
                secretKeyRef:
                  name: crowdsec-secrets
                  key: CROWDSEC_AGENT_USERNAME
            - name: AGENT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: crowdsec-secrets
                  key: CROWDSEC_AGENT_PASSWORD
          resources:
            limits:
              memory: 100Mi
            requests:
              cpu: 150m
              memory: 100Mi
          volumeMounts:
            #          {{ if (include "parsersIsNotEmpty" .) }}
            #          {{- range $stage, $stageConfig := .Values.config.parsers -}}
            #          {{- if $stageConfig -}}
            #          {{ range $fileName, $content := $stageConfig -}}
            #          - name: {{ printf "crowdsec-parsers-%s-%s" $stage (trimSuffix ".yaml" $fileName) }}
            #            mountPath: {{ printf "%s/parsers/%s/%s" $crowdsecConfig $stage $fileName }}
            #            subPath: {{ $fileName }}
            #          {{ end }}
            #          {{- end }}
            #          {{- end }}
            #          {{- end }}
            - name: acquis-config-volume
              mountPath: /etc/crowdsec/acquis.yaml
              subPath: acquis.yaml
            - name: varlog
              mountPath: /var/log
              readOnly: true
            - name: varlibdockercontainers
              mountPath: /var/lib/docker/containers
              readOnly: true
      terminationGracePeriodSeconds: 30
      volumes:
        - name: acquis-config-volume
          configMap:
            name: crowdsec-acquis-configmap
        - name: varlog
          hostPath:
            path: /var/log
        - name: varlibdockercontainers
          hostPath:
            path: /var/lib/docker/containers
#      {{ if (include "parsersIsNotEmpty" .) }}
#      {{- range $stage, $stageConfig := .Values.config.parsers -}}
#      {{- if $stageConfig -}}
#      {{ range $fileName, $content := $stageConfig -}}
#      - name: {{ printf "crowdsec-parsers-%s-%s" $stage (trimSuffix ".yaml" $fileName) }}
#        configMap:
#          name: {{ printf "crowdsec-parsers-%s" $stage }}
#          items:
#          - key: {{ $fileName }}
#            path: {{ $fileName }}
#      {{ end }}
#      {{- end }}
#      {{- end }}
#      {{- end }}
