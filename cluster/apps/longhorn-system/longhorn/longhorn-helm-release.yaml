---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: longhorn
  namespace: longhorn-system
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://charts.longhorn.io
      chart: longhorn
      version: 1.5.1
      sourceRef:
        kind: HelmRepository
        name: longhorn-charts
        namespace: flux-system
      interval: 5m
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    # https://github.com/longhorn/longhorn/issues/1861#issuecomment-716459507
    csi:
      kubeletRootDir: /var/lib/kubelet
    # Needed when using longhorn v1.4.0 to work with kubernetes <=1.24
    enablePSP: false
    persistence:
      defaultClassReplicaCount: 2
    defaultSettings:
      defaultReplicaCount: 2
    ingress:
      enabled: true
      host: "longhorn.${SECRET_DOMAIN}"
      tls: true
      ingressClassName: "nginx"
      tlsSecret: longhorn-tls
      annotations:
        nginx.ingress.kubernetes.io/connection-proxy-header: "upgrade"
        nginx.ingress.kubernetes.io/auth-url: "http://oauth2-proxy.networking.svc.cluster.local/oauth2/auth"
        nginx.ingress.kubernetes.io/auth-signin: "https://auth.${SECRET_DOMAIN}/oauth2/sign_in"